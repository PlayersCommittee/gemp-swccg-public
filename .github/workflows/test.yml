name: Gemp Client Basic Access Test
on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main

  pull_request:
    types:
      - opened
      - edited
      - synchronize    

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master

      - name: Building Gemp within the container using Maven
        working-directory: ./src/docker
        run: |
          docker build -f ./gemp_app.Dockerfile --tag 'gemp_build' .
          docker run -v ${GITHUB_WORKSPACE}:/opt/gemp-swccg --detach --name 'gemp_build' -it 'gemp_build'
          docker exec gemp_build mvn clean install
          docker stop gemp_build
          
          
      - name: Build the Gemp containers
        working-directory: ./src/docker
        run: |
          docker compose build
          docker compose up -d

      - name: Client Test
        run: |
          docker exec gemp_swccg_app_1 curl -s --retry 10 --retry-connrefused http://localhost/gemp-swccg/index.html
          echo "Python3: $(which python3)"
          echo "pip3...: $(which pip3)"
          pip3 install -r src/requirements.txt
          python3 src/gemp_client_test.py

