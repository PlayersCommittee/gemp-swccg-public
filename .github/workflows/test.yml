name: test-on-push

on:
  push:
    branches:
      - master
      - main
  pull_request:
    types:
      - opened
      - edited
      - synchronize

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Java properly (do NOT apt-get Java)
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # Maven build (IMPORTANT: run from src/)
      - name: Maven build
        working-directory: src
        run: mvn clean verify

      # Build Docker stack
      - name: Build Docker stack
        working-directory: src
        run: docker compose build

      # Start Docker stack
      - name: Start Docker stack
        working-directory: src
        run: docker compose up -d
      
        # Run integration tests
      - name: Run integration tests
        working-directory: src
        timeout-minutes: 10
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          set -euxo pipefail
          # Load ports from .env so we hit the mapped host port
          set -a
          source .env
          set +a
          APP_URL="http://127.0.0.1:${APP_PORT}/gemp-swccg/index.html"

          # Wait (with visibility) for the app to start responding
          timeout 240 bash -c '
            url="$1"
            until curl -fSs --max-time 10 --retry 30 --retry-delay 2 --retry-connrefused "$url"; do
              echo "Waiting for app to respond at ${url}..."
              docker compose ps
              docker compose logs --tail=50 build || true
              docker compose exec -T build sh -c "tail -n 50 /root/nohup.out || tail -n 50 /opt/gemp-swccg/src/nohup.out" || true
              sleep 5
            done
          ' bash "${APP_URL}"
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt
          python3 -u gemp_client_test.py
