name: test-on-push

on:
  push:
    branches:
      - master
      - main
  pull_request:
    types:
      - opened
      - edited
      - synchronize

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Java properly (do NOT apt-get Java)
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # Maven build (IMPORTANT: run from src/)
      - name: Maven build
        working-directory: src
        run: mvn clean verify

      # Build Docker stack
      - name: Build Docker stack
        working-directory: src
        run: docker compose build

      # Start Docker stack
      - name: Start Docker stack
        working-directory: src
        run: docker compose up -d
      
        # Run integration tests
      - name: Run integration tests
        working-directory: src
        timeout-minutes: 10
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          set -euxo pipefail
          # Wait (with visibility) for the app to start responding
          timeout 240 bash -c '
            until docker compose exec -T build curl -fSs --max-time 10 --retry 30 --retry-delay 2 --retry-connrefused http://127.0.0.1:8080/gemp-swccg/index.html; do
              echo "Waiting for app to respond..."
              docker compose ps
              docker compose logs --tail=50 build || true
              sleep 5
            done
          '
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt
          python3 -u gemp_client_test.py
