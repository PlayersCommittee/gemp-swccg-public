name: test-on-push

on:
  push:
    branches:
      - master
      - main
  pull_request:
    types:
      - opened
      - edited
      - synchronize

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Java properly (do NOT apt-get Java)
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # Maven build (IMPORTANT: run from src/)
      - name: Maven build
        working-directory: src
        run: mvn clean verify

      # Build Docker stack
      - name: Build Docker stack
        working-directory: src
        run: docker compose build

      # Start Docker stack
      - name: Start Docker stack
        working-directory: src
        run: docker compose up -d
      
        # Run integration tests
      - name: Run integration tests
        working-directory: src
        run: |
          docker compose exec build curl -s --retry 10 --retry-connrefused http://127.0.0.1:8080/gemp-swccg/index.html
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt
          python3 gemp_client_test.py
